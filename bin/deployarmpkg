#! /bin/bash

# Set globals
_LIBDIR=/usr/share/manjaro-arm-tools/lib

source $_LIBDIR/functions.sh

opt=":p:a:r:k:h"

while getopts "${opt}" arg; do
  case $arg in
    p)
      package="${OPTARG%/}"
      ;;
    a)
      arch="${OPTARG}"
      ;;
    r)
      repo="${OPTARG}"
      ;;
    k)
      gpgmail="${OPTARG}"
      ;;
    \?)
      echo "Invalid option: -${OPTARG}"
      exit 1
      ;;
    h|?)
      usage_deploy_package
      exit 1
      ;;
    :)
      echo "Option -${OPTARG} requires an argument."
      exit 1
      ;;
  esac
done

if [ "x" == "x$package" ]; then
  echo "-p [option] is required"
  exit
fi
if [ "x" == "x$repo" ]; then
  echo "-r [option] is required"
  exit
fi
if [ "x" == "x$gpgmail" ]; then
  echo "-k [option] is required"
  exit
fi

# Sign the package with the users gpg key
sign_pkg

# Upload pkg + signature to repo server
pkg_upload

# remove pkg + sig from cache folder
remove_local_pkg
