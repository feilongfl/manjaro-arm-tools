#!/bin/bash

# This script assumes the following packages are installed.
# manjaro-tools-base (repo)
# qemu (repo)
# parted (repo)
# qemu-user-static (aur)
# binfmt-support-git (aur)
# binfmt-qemu-static (aur)

usage="Variable list order: 
1=Device, 
2=Edition, 
3=Version,

Example: rpi2 minimal 18.05
Example2: oc2 server 18.05"

   
if [[ "$_DEVICE" = "oc2" ]]; then
    _ARCH='aarch64'
else
    _ARCH='armv7h'
fi

_ROOTFS="/var/lib/manjaro-arm-tools/img"
_TMPDIR="/var/lib/manjaro-arm-tools/tmp"
_IMAGEDIR="/var/cache/manjaro-arm-tools/img"
_LIBDIR="/usr/share/manjaro-arm-tools/lib"
#_ARCH="$4"
#_SIZE="$5"

#Package lists
PKG_RPI2=$(curl https://gitlab.com/Strit/arm-profiles/raw/master/devices/rpi2)
PKG_OC1=$(curl https://gitlab.com/Strit/arm-profiles/raw/master/devices/oc1)
PKG_OC2=$(curl https://gitlab.com/Strit/arm-profiles/raw/master/devices/oc2)
PKG_MINIMAL=$(curl https://gitlab.com/Strit/arm-profiles/raw/master/editions/minimal)
PKG_LXQT=$(curl https://gitlab.com/Strit/arm-profiles/raw/master/editions/lxqt)
PKG_MATE=$(curl https://gitlab.com/Strit/arm-profiles/raw/master/editions/mate)

#Display messages
   msg() {
     ALL_OFF="\e[1;0m"
     BOLD="\e[1;1m"
     GREEN="${BOLD}\e[1;32m"
       local mesg=$1; shift
       printf "${GREEN}==>${ALL_OFF}${BOLD} ${mesg}${ALL_OFF}\n" "$@" >&2
   }



case $1 in
rpi2)
msg "Creating rootfs for Raspberry Pi..."

# backup host mirrorlist
sudo mv /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist-orig

# Create arm mirrlorlist
echo "Server = http://mirror.strits.dk/manjaro-arm/stable/\$arch/\$repo/" > mirrorlist
sudo mv mirrorlist /etc/pacman.d/mirrorlist

# cd to root_fs
mkdir -p $_ROOTFS
cd $_ROOTFS

# create folder for the rootfs
mkdir -p rootfs_armv7h

    case $2 in
    minimal)
    # basescrap the rootfs filesystem
    basestrap -G -C $_LIBDIR/pacman.conf.armv7h $_ROOTFS/rootfs_armv7h $PKG_RPI2 $PKG_MINIMAL
    ;;
    lxqt)
    basestrap -G -C $_LIBDIR/pacman.conf.armv7h $_ROOTFS/rootfs_armv7h $PKG_RPI2 $PKG_LXQT 
    sudo systemd-nspawn -D rootfs_armv7h systemctl enable sddm.service
    ;;
    mate)
    basestrap -G -C $_LIBDIR/pacman.conf.armv7h $_ROOTFS/rootfs_armv7h $PKG_RPI2 $PKG_MATE
    sudo systemd-nspawn -D rootfs_armv7h systemctl enable lightdm.service
    ;;
    *)
    echo -e "$usage"
    ;;
    esac
    
# Enable cross architecture Chrooting
sudo cp /usr/bin/qemu-arm-static $_ROOTFS/rootfs_armv7h/usr/bin/
sudo update-binfmts --enable qemu-arm

msg "Enabling services..."

# Enable services
sudo systemd-nspawn -D rootfs_armv7h systemctl enable systemd-networkd.service sshd.service getty.target haveged.service dhcpcd.service

# restore original mirrorlist to host system
sudo mv /etc/pacman.d/mirrorlist-orig /etc/pacman.d/mirrorlist
sudo pacman -Syy

msg "Setting up users..."
#setup users
sudo systemd-nspawn -D rootfs_armv7h passwd root < $_LIBDIR/pass-root
sudo systemd-nspawn -D rootfs_armv7h useradd -m -g users -G wheel,storage,network,power,users -s /bin/bash manjaro
sudo systemd-nspawn -D rootfs_armv7h passwd manjaro < $_LIBDIR/pass-manjaro

msg "Setting up system settings..."
#system setup
sudo systemd-nspawn -D rootfs_armv7h chmod u+s /usr/bin/ping
sudo systemd-nspawn -D rootfs_armv7h update-ca-trust
sudo cp $_LIBDIR/10-installer $_ROOTFS/rootfs_armv7h/etc/sudoers.d/
sudo cp $_LIBDIR/resize-sd $_ROOTFS/rootfs_armv7h/usr/bin/
sudo cp $_LIBDIR/20-wired.network $_ROOTFS/rootfs_armv7h/etc/systemd/network/

msg "Setting up keyrings..."
#setup keys
sudo systemd-nspawn -D rootfs_armv7h pacman-key --init
sudo systemd-nspawn -D rootfs_armv7h pacman-key --populate manjaro archlinuxarm manjaro-arm

msg "Raspberry Pi $2 rootfs complete"
    ;;
    
oc1)
msg "Creating rootfs for Odroid-C1..."

# backup host mirrorlist
sudo mv /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist-orig

# Create arm mirrlorlist
echo "Server = http://mirror.strits.dk/manjaro-arm/stable/\$arch/\$repo/" > mirrorlist
sudo mv mirrorlist /etc/pacman.d/mirrorlist

# cd to root_fs
cd $_ROOTFS

# create folder for the rootfs
mkdir -p rootfs_armv7h

    case $2 in
    minimal)
    # basescrap the rootfs filesystem
    basestrap -G -C $_LIBDIR/pacman.conf.armv7h $_ROOTFS/rootfs_armv7h $PKG_OC1 $PKG_MINIMAL
 ;;
    lxqt)
    basestrap -G -C $_LIBDIR/pacman.conf.armv7h $_ROOTFS/rootfs_armv7h $PKG_OC1 $PKG_LXQT
    sudo systemd-nspawn -D rootfs_armv7h systemctl enable lightdm.service
    ;;
    mate)
    basestrap -G -C $_LIBDIR/pacman.conf.armv7h $_ROOTFS/rootfs_armv7h $PKG_OC1 $PKG_MATE
    sudo systemd-nspawn -D rootfs_armv7h systemctl enable lightdm.service
    ;;
    *)
    echo -e "$usage"
    ;;
    esac
    
# Enable cross architecture Chrooting
sudo cp /usr/bin/qemu-arm-static $_ROOTFS/rootfs_armv7h/usr/bin/
sudo update-binfmts --enable qemu-arm

msg "Enabling services..."
# Enable services
sudo systemd-nspawn -D rootfs_armv7h systemctl enable systemd-networkd.service sshd.service getty.target haveged.service dhcpcd.service

# restore original mirrorlist to host system
sudo mv /etc/pacman.d/mirrorlist-orig /etc/pacman.d/mirrorlist
sudo pacman -Syy

msg "Setting up users..."
#setup users
sudo systemd-nspawn -D rootfs_armv7h passwd root < $_LIBDIR/pass-root
sudo systemd-nspawn -D rootfs_armv7h useradd -m -g users -G wheel,storage,network,power,users -s /bin/bash manjaro
sudo systemd-nspawn -D rootfs_armv7h passwd manjaro < $_LIBDIR/pass-manjaro

msg "Setting up system settings..."
#system setup
sudo systemd-nspawn -D rootfs_armv7h chmod u+s /usr/bin/ping
sudo systemd-nspawn -D rootfs_armv7h update-ca-trust
#sudo systemd-nspawn -D rootfs_armv7h mkdir -p /etc/sudoers.d
sudo cp $_LIBDIR/10-installer $_ROOTFS/rootfs_armv7h/etc/sudoers.d/
sudo cp $_LIBDIR/resize-sd $_ROOTFS/rootfs_armv7h/usr/bin/
sudo cp $_LIBDIR/20-wired.network $_ROOTFS/rootfs_armv7h/etc/systemd/network/

msg "Setting up keyrings..."
#setup keys
sudo systemd-nspawn -D rootfs_armv7h pacman-key --init
sudo systemd-nspawn -D rootfs_armv7h pacman-key --populate manjaro archlinuxarm manjaro-arm


msg "Odroid-C1 $2 rootfs complete"
    ;;

oc2)
msg "Creating rootfs for Odroid-C2..."

# backup host mirrorlist
sudo mv /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist-orig

# Create arm mirrlorlist
echo "Server = http://mirror.strits.dk/manjaro-arm/stable/\$arch/\$repo/" > mirrorlist
sudo mv mirrorlist /etc/pacman.d/mirrorlist

# cd to root_fs
cd $_ROOTFS

# create folder for the rootfs
mkdir -p rootfs_aarch64

    case $2 in
    minimal)
    # basescrap the rootfs filesystem
    basestrap -G -C $_LIBDIR/pacman.conf.aarch64 $_ROOTFS/rootfs_aarch64 $PKG_OC2 $PKG_MINIMAL
    ;;
    lxqt)
    basestrap -G -C $_LIBDIR/pacman.conf.aarch64 $_ROOTFS/rootfs_aarch64 $PKG_OC2 $PKG_LXQT
    sudo systemd-nspawn -D rootfs_armv7h systemctl enable lightdm.service
    ;;
    mate)
    basestrap -G -C $_LIBDIR/pacman.conf.aarch64 $_ROOTFS/rootfs_aarch64 $PKG_OC2 $PKG_MATE
    sudo systemd-nspawn -D rootfs_armv7h systemctl enable lightdm.service
    ;;
    *)
    echo -e "$usage"
    ;;
    esac
    
# Enable cross architecture Chrooting
sudo cp /usr/bin/qemu-aarch64-static $_ROOTFS/rootfs_aarch64/usr/bin/
sudo update-binfmts --enable qemu-aarch64

msg "Enabling services..."
# Enable services
sudo systemd-nspawn -D rootfs_aarch64 systemctl enable systemd-networkd.service sshd.service getty.target haveged.service dhcpcd.service

# restore original mirrorlist to host system
sudo mv /etc/pacman.d/mirrorlist-orig /etc/pacman.d/mirrorlist
sudo pacman -Syy

msg "Setting up users..."
#setup users
sudo systemd-nspawn -D rootfs_aarch64 passwd root < $_LIBDIR/pass-root
sudo systemd-nspawn -D rootfs_aarch64 useradd -m -g users -G wheel,storage,network,power,users -s /bin/bash manjaro
sudo systemd-nspawn -D rootfs_aarch64 passwd manjaro < $_LIBDIR/pass-manjaro

msg "Setting up system settings..."
#system setup
sudo systemd-nspawn -D rootfs_aarch64 chmod u+s /usr/bin/ping
sudo systemd-nspawn -D rootfs_aarch64 update-ca-trust
sudo cp $_LIBDIR/10-installer $_ROOTFS/rootfs_aarch64/etc/sudoers.d/
sudo cp $_LIBDIR/resize-sd $_ROOTFS/rootfs_aarch64/usr/bin/
sudo cp $_LIBDIR/20-wired.network $_ROOTFS/rootfs_aarch64/etc/systemd/network/

msg "Setting up keyrings..."
#setup keys
sudo systemd-nspawn -D rootfs_aarch64 pacman-key --init
sudo systemd-nspawn -D rootfs_aarch64 pacman-key --populate manjaro archlinuxarm manjaro-arm

msg "Odroid-C2 $2 rootfs complete"
    ;;
    
*)
    echo -e "$usage"
    ;;
esac


msg "Creating image!"

#GLOBALS
#_ARCH="$4"
#_DEVICE="$1"
#_EDITION="$2"
#_SIZE="$5"
#_VERSION="$3"
#_DATE=$(date +"%g.%m-%d-%H%M")
_IMGNAME="Manjaro-ARM-$2-$1-$3"

# Test for device input
if [[ "$1" != "rpi2" && "$1" != "oc1" && "$1" != "oc2" && "$1" != "xu4" && "$1" != "bbb" && "$1" != "bbxm" ]]; then
        echo 'Invalid device '$1', please choose one of the following'
        echo 'rpi2  |  oc1  | oc2  |  xu4  '
	exit 1
else
   	_DEVICE="$1"
fi

#if [ ! -d "$_ROOTFS/rootfs_$_ARCH" ]; then
#   echo 'The 'rootfs_$_ARCH' directory does not exist'
#   echo 'Please enter a valid rootfs.'
#   exit 2
#fi

if [[ "$_EDITION" = "minimal" ]]; then
    _SIZE=1500
else
    _SIZE=2000
fi

msg "Please ensure that the rootfs is configured and all necessary boot packages are installed"

##Image set up
#making blank .img to be used
sudo dd if=/dev/zero of=$_IMAGEDIR/$_IMGNAME.img bs=1M count=$_SIZE

#probing loop into the kernel
sudo modprobe loop

#set up loop device
LDEV=`sudo losetup -f`
DEV=`echo $LDEV | cut -d "/" -f 3`

#mount image to loop device
sudo losetup $LDEV $_IMAGEDIR/$_IMGNAME.img



if [[ "$_DEVICE" = "rpi2" ]]; then
#partition with boot and root
	sudo parted -s $LDEV mklabel msdos
	sudo parted -s $LDEV mkpart primary fat32 0% 100M
	START=`cat /sys/block/$DEV/${DEV}p1/start`
	SIZE=`cat /sys/block/$DEV/${DEV}p1/size`
	END_SECTOR=$(expr $START + $SIZE)
	sudo parted -s $LDEV mkpart primary ext4 "${END_SECTOR}s" 100%
	sudo partprobe $LDEV
	sudo mkfs.vfat "${LDEV}p1"
	sudo mkfs.ext4 "${LDEV}p2"

#copy rootfs contents over to the FS
	mkdir -p $_TMPDIR/root
	mkdir -p $_TMPDIR/boot
	sudo mount ${LDEV}p1 $_TMPDIR/boot
	sudo mount ${LDEV}p2 $_TMPDIR/root
	sudo cp -ra $_ROOTFS/rootfs_$_ARCH/* $_TMPDIR/root/
	sudo mv $_TMPDIR/root/boot/* $_TMPDIR/boot

#clean up
	sudo umount $_TMPDIR/root
	sudo umount $_TMPDIR/boot
	sudo losetup -d $LDEV
	sudo rm -r $_TMPDIR/root $_TMPDIR/boot
	sudo partprobe $LDEV

elif [[ "$_DEVICE" = "oc1" ]] || [[ "$_DEVICE" = "oc2" ]] || [[ "$_DEVICE" = "xu4" ]]; then
#Clear first 8mb
	sudo dd if=/dev/zero of=${LDEV} bs=1M count=8
	
#partition with a single root partition
	sudo parted -s $LDEV mklabel msdos
	sudo parted -s $LDEV mkpart primary ext4 0% 100%
	sudo partprobe $LDEV
#if [[ "$_DEVICE" = "xu4" ]]; then
#	sudo mkfs.ext4 "${LDEV}p1"
#else
	sudo mkfs.ext4 -O ^metadata_csum,^64bit ${LDEV}p1
#fi

#copy rootfs contents over to the FS
	mkdir -p $_TMPDIR/root
	sudo chmod 777 -R $_TMPDIR/root
	sudo mount ${LDEV}p1 $_TMPDIR/root
	sudo cp -ra $_ROOTFS/rootfs_$_ARCH/* $_TMPDIR/root/

#flash bootloader
	cd $_TMPDIR/root/boot/
	sudo ./sd_fusing.sh $LDEV
	cd ~

#clean up
	sudo umount $_TMPDIR/root
	sudo losetup -d $LDEV
	sudo rm -r $_TMPDIR/root
	sudo partprobe $LDEV

else
	echo "The $_DEVICE" has not been set up yet
fi

#zip img
cd $_IMAGEDIR
zip -9 $_IMGNAME.zip $_IMGNAME.img 
sudo rm $_IMAGEDIR/$_IMGNAME.img

msg "Removing rootfs_$_ARCH"
sudo rm -rf $_ROOTFS/rootfs_$_ARCH
