#! /bin/bash

# Set globals
LIBDIR=/usr/share/manjaro-arm-tools/lib
KEEPROOTFS=true

#imports
source $LIBDIR/functions.sh

#Arguments 
opt=":e:d:v:nh"

while getopts "${opt}" arg; do
  case $arg in
    e)
      EDITION="${OPTARG}"
      ;;
    d)
      DEVICE="${OPTARG}"
      ;;
    v)
      VERSION="${OPTARG}"
      ;;
    n)
      KEEPROOTFS=false
      ;;
    \?)
      echo "Invalid option: -${OPTARG}"
      exit 1
      ;;
    h|?)
      usage_build_oem
      exit 1
      ;;
    :)
      echo "Option -${OPTARG} requires an argument."
      exit 1
      ;;
  esac
done


IMGNAME=Manjaro-ARM-$EDITION-$DEVICE-$VERSION

   
if [[ "$DEVICE" = "oc1" ]] || [[ "$DEVICE" = "rpi2" ]] || [[ "$DEVICE" = "xu4" ]] || [[ "$DEVICE" = "nyan-big" ]]; then
    ARCH='armv7h'
else
    ARCH='aarch64'
fi

if [ ! -d "$PROFILES/arm-profiles" ]; then
    getarmprofiles
fi

# start the timer
timer_start=$(get_timer)

#Package lists
PKG_DEVICE=$(grep "^[^#;]" $PROFILES/arm-profiles/devices/$DEVICE | awk '{print $1}')
PKG_EDITION=$(grep "^[^#;]" $PROFILES/arm-profiles/editions/$EDITION | awk '{print $1}')
SRV_EDITION=$(grep "^[^#;]" $PROFILES/arm-profiles/services/$EDITION | awk '{print $1}')

#start timer
#timer=$(get_timer)

# Creating the rootfs used for the image.
create_rootfs_oem
create_img
create_zip

# show timer
show_elapsed_time "${FUNCNAME}" "${timer_start}"
